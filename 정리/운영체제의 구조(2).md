## 운영체제의 구조 (2)

### CPU Protection Rings

- CPU도 권한 모드를 가지고 있다.

  - 사용자 모드(user mode)
    - **응용 프로그램이 사용한다.**
  - 커널 모드(kernel mode) : **특권 명령어 실행**과 원하는 작업 수행을 위한 **자원 접근**을 가능하게 하는 모드이다.
    - **OS를 사용한다.**
    - 특권 명령은 커널 모드가 되어야지만 가능한 것이다.
  - **Intel CPU의 CPU Protection Rings 4가지 모드 제공**
  - <img src="https://user-images.githubusercontent.com/40616436/75623341-5eda5d80-5bec-11ea-996b-26e30278b4d8.png" alt="image" style="zoom:50%;" />
    - 대부분의 운영체제에서는 두 가지 모드를 다룬다.
      - Ring 3 : 사용자 모드
      - Ring 0 : 커널 모드

  

### 응용 프로그램과 운영체제

- 우리가 만드는 프로그램은 **응용 프로그램**이다.

<img src="https://user-images.githubusercontent.com/40616436/75623763-c0043000-5bf0-11ea-826b-a90424d80e0f.png" alt="image" style="zoom:50%;" />

- 응용 프로그램과 API는 사용자 모드에서 CPU를 실행하는 것이다.
- 응용 프로그램이 운영체제에 뭔가 요청을 하게 되면 API를 통해서 시스템 콜을 하게되는데, 이 때 해당 요청은 커널 모드에서 실행이 되는 것이다. 즉, 커널 모드에서 운영체제를 사용하게 된다.
- Ex.
  1. 1~1000을 더한다.
     - 응용 프로그램을 실행한다.
  2. 파일에서 데이터를 가져온다.
     - **파일을 읽어달라는 시스템 콜을 통해 커널 모드로 전환되고 커널 모드에서 운영체제에 있는 디스크를 읽고 오게 된다.**
  3. 해당 데이터와 1~1000을 더한 값을 다시 더한다.
     - 응용 프로그램을 실행한다.
  4. 출력한다.



- **어떤 명령어는 사용자 모드에서 실행이 되는 것이고, 어떤 명령은 시스템 콜을 통해서 커널 모드에서 실행이 되는 것이다.**



### 시스템 콜은 커널 모드로 실행한다.

- 커널 모드에서만 실행 가능한 기능들이 있다.
  - 응용 프로그램에서 커널 모드에서만 실행 가능한 기능들을 강제적으로 사용하기 위해 CPU를 실행하려고 해도, 현재 모드는 사용자 모드이기 때문에 실행되지 않는다.
- 커널 모드로 실행하려면, 반드시 시스템 콜을 거쳐야 한다.
- 해당 시스템 콜은 운영체제에서 제공한다.
  - 커널 모드에서 실행가능한 운영체제들을 사용하기 위해 운영체제는 시스템 콜을 제공한 것이다.



### 사용자 모드와 커널 모드

- 함부로 응용 프로그램이 전체 컴퓨터 시스템을 해치지 못한다.
- Ex. 주민등록등본은 동사무소 혹은 민원 24시에서 특별한 신청서를 작성해야지만 발급되는 것과 유사한 원리이다.
  - 주민등록등본은 동사무소 혹은 민원 24시에서만 발급된다. **(사용자 모드)**
  - 주민등록등본을 발급하기 위해선 특별한 신청서를 작성해야한다. **(시스템 콜)**
  - 동사무소 직원들은 특별한 권한을 가지고 있어, 주민등록등본 출력 명령을 실행할 수 있는 것이다. **(커널 모드)**



### 코드 예제 1

![image](https://user-images.githubusercontent.com/40616436/75624981-f9db3380-5bfc-11ea-8d18-17bcea6482f4.png)

- open() -> 저장매체에 있는 파일을 오픈한다 (OS가 관리하므로, system call에 해당한다.)
  - 즉, 커널 모드로 전환하여 운영체제에 접근한다.
- if() -> 사용자 모드로 전환



### 코드 예제 2

![image](https://user-images.githubusercontent.com/40616436/75625073-debcf380-5bfd-11ea-8197-0657518b32b7.png)

- open()은 결과적으로, **커널 모드에서 해당 시스템 콜을 처리하는 운영체제 함수로 접근하는 것이다.**



### 정리

- 운영체제는 시스템 콜을 제공한다.
- 프로그래밍 언어별로 운영체제의 기능을 활용하기 위해, **시스템 콜을 기반으로 API를 제공한다.**
- 응용 프로그램은 운영체제 기능이 필요할 시, 해당 API를 사용해서(**커널 모드로 전환**) 프로그램을 작성하는 것이다.
- **응용 프로그램에서 운영체제 까지..**
  1. **응용 프로그램에서 운영체제 기능 필요**
  2. **운영체제 기능이 필요한 API 호출**
  3. **API 호출로 인해 시스템 콜 호출**
  4. **시스템 콜 호출로 사용자 모드에서 커널 모드로 전환**
  5. **커널 모드로 인해 OS에 접근이 가능하므로 해당하는 OS 함수 호출**
  6. **호출 결과 응용 프로그램에 전달**



